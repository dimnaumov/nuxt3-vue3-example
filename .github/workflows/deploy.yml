name: Deploy Nuxt3 App

on:
  push:
    tags:
      - '*'  # –ó–∞–ø—É—Å–∫ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ —Ç–µ–≥–∞
  workflow_dispatch:  # –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'

      - name: üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: npm install

      - name: üîß –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
        run: npm run build

      - name: üöÄ –î–µ–ø–ª–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä —á–µ—Ä–µ–∑ rsync
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          SERVER_USER: ${{ secrets.SSH_USER }}
          SERVER_HOST: ${{ secrets.SSH_HOST }}
          SERVER_PATH: "/var/www/nuxt3-vue3-example"
        run: |
          echo "$SSH_PRIVATE_KEY" > private_key && chmod 600 private_key
      
          # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
          ssh -i private_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            if [ -z "$SERVER_PATH" ] || [ "$SERVER_PATH" == "/" ]; then
              echo "–û—à–∏–±–∫–∞: SERVER_PATH –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ –∫–æ—Ä–µ–Ω—å!"
              exit 1
            fi
            mkdir -p "$SERVER_PATH"
          EOF
      
          # –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã –∏ —Å–∞–º—É –ø–∞–ø–∫—É .output
          rsync -avz --delete --progress -e "ssh -i private_key -o StrictHostKeyChecking=no" .output $SERVER_USER@$SERVER_HOST:$SERVER_PATH
      
      - name: üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ PM2
        env:
          SERVER_USER: ${{ secrets.SSH_USER }}
          SERVER_HOST: ${{ secrets.SSH_HOST }}
          SERVER_PATH: "/var/www/nuxt3-vue3-example"
        run: |
          ssh -i private_key -o StrictHostKeyChecking=no $SERVER_USER@$SERVER_HOST << 'EOF'
            export SERVER_PATH="/var/www/nuxt3-vue3-example"
      
            # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ pm2 –≤ PATH (–ø—É—Ç—å, —É–∫–∞–∑–∞–Ω–Ω—ã–π –≤ which pm2)
            export PATH=$PATH:/root/.nvm/versions/node/v22.14.0/bin
      
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ pm2
            cd $SERVER_PATH
            pm2 stop nuxt-app || true
            pm2 start .output/server/index.mjs --name nuxt-app
            pm2 save
          EOF

      - name: üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
        run: rm -f private_key
